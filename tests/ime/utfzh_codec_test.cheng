import cheng/gui/ime/utfzh_codec
import cheng/gui/ime/cangwu_assets_loader
import cheng/gui/ime/cangwu_types

fn testDictLoad(): int32 =
    let dict = cwLoadUtfZhDict("src/ime/data")
    if len(dict.codepoints) != 9698:
        return 1
    if len(dict.chars) != 9698:
        return 2
    return 0

fn testBasic(): int32 =
    let dict = cwLoadUtfZhDict("src/ime/data")
    let text = "abc"
    let enc = utfZhEncodeStrict(text, dict)
    if ! enc.ok:
        return 101
    if len(enc.bytes) != len(text):
        return 102
    let dec = utfZhDecodeStrict(enc.bytes, dict)
    if ! dec.ok || dec.text != text:
        return 103
    return 0

fn testDictHead(): int32 =
    let dict = cwLoadUtfZhDict("src/ime/data")
    let text = dict.chars[33] + dict.chars[34] + dict.chars[1505] + dict.chars[1506] + dict.chars[9697]
    let enc = utfZhEncodeStrict(text, dict)
    if ! enc.ok:
        return 201
    let dec = utfZhDecodeStrict(enc.bytes, dict)
    if ! dec.ok || dec.text != text:
        return 202
    return 0

fn testOverlongAndContinuation(): int32 =
    let dict = cwLoadUtfZhDict("src/ime/data")
    let overlongAscii = charToStr(char(0xFB)) + charToStr(char(0x80)) + charToStr(char(0x81)) + charToStr(char(0x81))
    let dec1 = utfZhDecodeStrict(overlongAscii, dict)
    if dec1.errorCount <= 0:
        return 301
    let badCont = charToStr(char(0xE2)) + charToStr(char(0x41))
    let dec2 = utfZhDecodeStrict(badCont, dict)
    if dec2.errorCount <= 0:
        return 302
    return 0

fn main(): int32 =
    var rc = testDictLoad()
    if rc != 0:
        return rc
    rc = testBasic()
    if rc != 0:
        return rc
    rc = testDictHead()
    if rc != 0:
        return rc
    rc = testOverlongAndContinuation()
    if rc != 0:
        return rc
    return 0

main()
